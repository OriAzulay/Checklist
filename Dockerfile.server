# Build stage
FROM node:20-alpine AS build

WORKDIR /app

COPY server/package*.json ./server/
RUN cd server && npm ci

COPY server ./server

RUN npm --prefix server run build

# Runtime stage
FROM node:20-alpine

WORKDIR /app

COPY server/package*.json ./server/
RUN cd server && npm ci --only=production

COPY --from=build /app/server/dist ./server/dist
COPY --from=build /app/server/package*.json ./server/

RUN mkdir -p /app/data

EXPOSE 3000

ENV NODE_ENV=production
ENV PORT=3000
ENV DB_PATH=/app/data/tasks.db

CMD ["node", "server/dist/index.js"]
